import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot } from 'firebase/firestore';
import { ChevronRight, ChevronLeft, Database, CheckCircle2, Sparkles, Users, Lock, Circle } from 'lucide-react';

// ==========================================
// ðŸŸ¢ SECURE DATABASE INITIALIZATION
// The environment automatically and securely injects your 
// publishable config keys here. No manual copying needed!
// ==========================================
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- SURVEY CONFIGURATION ---
const SURVEY_CONFIG = {
    title: "Vision Pro Feedback",
    description: "Experience the future of feedback with our immersive interface.",
    questions: [
        { id: "q1", type: "text", question: "What impressed you most today?", placeholder: "Share your thoughts...", required: true },
        { id: "q2", type: "choice", question: "Preferred Interaction Mode?", options: ["Eye Tracking", "Hand Gestures", "Voice Command", "Physical Controller"], required: true },
        { id: "q3", type: "rating", question: "Immersion Quality", maxRating: 5, required: true },
        { id: "q4", type: "text", question: "Any additional notes?", placeholder: "Optional...", required: false }
    ]
};

// --- PARTICLES COMPONENT ---
const ParticleBackground = () => {
    const canvasRef = useRef(null);
    useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let animationFrameId;
        let particles = [];

        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.4 - 0.2; this.speedY = Math.random() * 0.4 - 0.2;
                this.opacity = Math.random() * 0.4 + 0.1;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if (this.x > canvas.width) this.x = 0; if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0; if (this.y < 0) this.y = canvas.height;
            }
            draw() {
                ctx.fillStyle = `rgba(16, 185, 129, ${this.opacity})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }
        const init = () => { particles = []; for (let i = 0; i < 80; i++) particles.push(new Particle()); };
        const animate = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            animationFrameId = requestAnimationFrame(animate);
        };
        window.addEventListener('resize', resize); resize(); init(); animate();
        return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animationFrameId); };
    }, []);
    return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-0" />;
};

// --- ADMIN DASHBOARD COMPONENT ---
const AdminDashboard = ({ user, onBack }) => {
    const [responses, setResponses] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState("");

    useEffect(() => {
        if (!user) return; // Guard query to ensure security

        const responsesRef = collection(db, 'artifacts', appId, 'public', 'data', 'survey_responses');
        
        const unsubscribe = onSnapshot(responsesRef, 
            (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort newest first in memory
                data.sort((a, b) => b.timestamp - a.timestamp);
                setResponses(data);
                setLoading(false);
            }, 
            (err) => {
                console.error("Fetch Error:", err);
                setError("Failed to load secure data.");
                setLoading(false);
            }
        );

        return () => unsubscribe();
    }, [user]);

    if (loading) return <div className="min-h-screen bg-[#050505] flex items-center justify-center"><div className="w-10 h-10 border-2 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin"></div></div>;

    return (
        <div className="min-h-screen bg-[#050505] text-white p-6 md:p-12 relative overflow-hidden">
            <ParticleBackground />
            <div className="max-w-6xl mx-auto relative z-10">
                <button onClick={onBack} className="inline-flex items-center gap-2 text-sm text-emerald-400 hover:text-emerald-300 mb-8 transition-colors">
                    <ChevronLeft size={16} /> Back to Survey
                </button>
                <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                    <div>
                        <h1 className="text-4xl font-bold tracking-tight bg-gradient-to-r from-white to-white/50 bg-clip-text text-transparent flex items-center gap-3">
                            <Database size={36} className="text-emerald-400" /> Admin Dashboard
                        </h1>
                        <p className="text-slate-400 mt-2">Live updates powered by secure built-in database.</p>
                    </div>
                    <div className="flex items-center gap-3 bg-white/5 px-5 py-3 rounded-2xl border border-white/10 backdrop-blur-md w-fit">
                        <Users className="text-emerald-400" size={24} />
                        <span className="font-bold text-xl">{responses.length}</span>
                        <span className="text-slate-400 text-sm">Total Responses</span>
                    </div>
                </header>
                {error && <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-6 py-4 rounded-xl mb-8">{error}</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {responses.map((res, i) => (
                        <div key={res.id} className="bg-[#0f0f12]/60 backdrop-blur-xl border border-white/10 rounded-3xl p-6 shadow-xl">
                            <div className="flex justify-between items-center mb-6 pb-4 border-b border-white/5 text-sm font-mono">
                                <span className="text-white/40">#{responses.length - i}</span>
                                <span className="text-emerald-400/80">{new Date(res.timestamp).toLocaleDateString()}</span>
                            </div>
                            <div className="space-y-5">
                                {SURVEY_CONFIG.questions.map(q => (
                                    <div key={q.id}>
                                        <p className="text-[11px] uppercase tracking-wider text-white/30 font-bold mb-1">{q.question}</p>
                                        <p className="text-white/90 font-medium">{res.answers[q.id] || "Skipped"}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- MAIN APP ---
export default function App() {
    const [user, setUser] = useState(null);
    const [view, setView] = useState('survey'); // 'survey' or 'admin'
    const [currentIndex, setCurrentIndex] = useState(-1);
    const [answers, setAnswers] = useState({});
    const [isSubmitted, setIsSubmitted] = useState(false);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState("");

    // Setup Secure Authentication automatically in the background
    useEffect(() => {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
    }, []);

    const handleNext = () => {
        if (currentIndex === -1) { setCurrentIndex(0); return; }
        const currentQuestion = SURVEY_CONFIG.questions[currentIndex];
        
        if (currentQuestion.required && !answers[currentQuestion.id]) {
            setError("Please provide an answer to continue."); return;
        }
        
        setError("");
        if (currentIndex < SURVEY_CONFIG.questions.length - 1) {
            setCurrentIndex(prev => prev + 1);
        } else {
            submitSurvey();
        }
    };

    const submitSurvey = async () => {
        if (!user) {
            setError("Secure connection not ready. Please try again in a moment.");
            return;
        }

        setLoading(true);
        try {
            const responsesRef = collection(db, 'artifacts', appId, 'public', 'data', 'survey_responses');
            await addDoc(responsesRef, {
                answers,
                userId: user.uid,
                timestamp: Date.now()
            });
            setIsSubmitted(true);
        } catch (err) {
            console.error(err);
            setError("Security Error: Failed to save response.");
        } finally { 
            setLoading(false); 
        }
    };

    if (view === 'admin') {
        return <AdminDashboard user={user} onBack={() => setView('survey')} />;
    }

    if (loading) return <div className="min-h-screen bg-[#050505] flex items-center justify-center"><div className="w-10 h-10 border-2 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin"></div></div>;

    return (
        <div className="min-h-screen bg-[#050505] text-white font-sans flex flex-col relative overflow-hidden">
            <ParticleBackground />
            
            <main className="relative z-10 flex-grow flex flex-col items-center justify-center p-6">
                <div className="w-full max-w-xl relative bg-[#0f0f12]/60 backdrop-blur-3xl border border-white/10 rounded-[2.5rem] shadow-2xl p-8 md:p-14 transition-all duration-500">
                    {isSubmitted ? (
                        <div className="text-center space-y-6 py-10">
                            <div className="w-20 h-20 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center mx-auto border border-emerald-500/30">
                                <CheckCircle2 size={44} />
                            </div>
                            <h1 className="text-4xl font-bold tracking-tight">Success</h1>
                            <p className="text-slate-400 text-lg">Response saved securely in the database.</p>
                            <button onClick={() => { setIsSubmitted(false); setCurrentIndex(-1); setAnswers({}); }} className="mt-4 text-emerald-400 hover:text-emerald-300 transition-colors">Submit Another Response</button>
                        </div>
                    ) : currentIndex === -1 ? (
                        <div className="text-center space-y-8 py-4">
                            <div className="inline-flex items-center gap-2 px-4 py-2 bg-white/5 border border-white/10 rounded-full text-[10px] font-bold text-emerald-300 tracking-widest uppercase">
                                <Sparkles size={12} /> Live Preview Ready
                            </div>
                            <h1 className="text-5xl font-extrabold tracking-tight bg-gradient-to-b from-white to-white/50 bg-clip-text text-transparent">
                                {SURVEY_CONFIG.title}
                            </h1>
                            <p className="text-slate-400 text-lg max-w-sm mx-auto">{SURVEY_CONFIG.description}</p>
                            <button onClick={handleNext} className="px-10 py-5 bg-white/10 border border-white/20 text-white rounded-2xl font-bold transition-all hover:bg-white/20 flex items-center justify-center gap-3 mx-auto shadow-lg hover:shadow-emerald-500/10">
                                Start Experience <ChevronRight size={20} />
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-10">
                            <div className="space-y-2">
                                <span className="text-[10px] font-black text-white/30 uppercase tracking-[0.2em]">Step {currentIndex + 1} of {SURVEY_CONFIG.questions.length}</span>
                                <h2 className="text-3xl font-medium text-white">{SURVEY_CONFIG.questions[currentIndex].question}</h2>
                            </div>
                            
                            <div className="min-h-[160px]">
                                {SURVEY_CONFIG.questions[currentIndex].type === 'text' && (
                                    <textarea 
                                        autoFocus 
                                        className="w-full p-6 bg-white/[0.03] border border-white/10 rounded-2xl outline-none focus:border-emerald-500/50 transition-colors h-40 text-lg resize-none" 
                                        placeholder={SURVEY_CONFIG.questions[currentIndex].placeholder}
                                        value={answers[SURVEY_CONFIG.questions[currentIndex].id] || ""} 
                                        onChange={(e) => setAnswers({...answers, [SURVEY_CONFIG.questions[currentIndex].id]: e.target.value})} 
                                    />
                                )}
                                
                                {SURVEY_CONFIG.questions[currentIndex].type === 'choice' && (
                                    <div className="grid gap-3">
                                        {SURVEY_CONFIG.questions[currentIndex].options.map(opt => (
                                            <button 
                                                key={opt} 
                                                onClick={() => setAnswers({...answers, [SURVEY_CONFIG.questions[currentIndex].id]: opt})} 
                                                className={`p-5 rounded-2xl border text-left font-medium transition-all ${answers[SURVEY_CONFIG.questions[currentIndex].id] === opt ? "bg-white text-black border-white shadow-lg" : "bg-white/[0.03] border-white/10 hover:border-emerald-500/50"}`}
                                            >
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                )}

                                {SURVEY_CONFIG.questions[currentIndex].type === 'rating' && (
                                    <div className="flex gap-3 justify-center">
                                        {[...Array(SURVEY_CONFIG.questions[currentIndex].maxRating)].map((_, i) => (
                                            <button 
                                                key={i} 
                                                onClick={() => setAnswers({...answers, [SURVEY_CONFIG.questions[currentIndex].id]: i + 1})}
                                                className={`w-14 h-14 rounded-2xl border text-xl font-bold flex items-center justify-center transition-all ${answers[SURVEY_CONFIG.questions[currentIndex].id] === i + 1 ? "bg-emerald-500 text-black border-emerald-500 shadow-lg" : "bg-white/[0.03] border-white/10 hover:border-emerald-500/50"}`}
                                            >
                                                {i + 1}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {error && <div className="text-red-400 text-sm flex items-center gap-2"><Circle size={16} fill="currentColor" /> {error}</div>}
                            
                            <div className="flex items-center justify-between pt-8 border-t border-white/5">
                                <button onClick={() => setCurrentIndex(currentIndex - 1)} className="flex items-center gap-2 text-white/30 hover:text-white/60 transition-colors"><ChevronLeft size={20} /> Back</button>
                                <button onClick={handleNext} className="px-8 py-4 bg-white/10 border border-white/20 text-white rounded-2xl font-bold hover:bg-emerald-500 hover:text-black hover:border-emerald-500 transition-all">
                                    {currentIndex === SURVEY_CONFIG.questions.length - 1 ? "Submit" : "Next"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </main>
            
            <footer className="pb-8 w-full z-20 flex flex-col items-center gap-4 relative">
                <div className="px-6 py-3 bg-white/5 border border-white/10 rounded-full flex items-center gap-6 text-[10px] uppercase tracking-widest font-black text-white/40">
                    <div className="flex items-center gap-2 text-emerald-400"><Database size={12} /> Secure Cloud Active</div>
                </div>
                <button onClick={() => setView('admin')} className="text-white/20 hover:text-white/60 text-[10px] uppercase font-bold tracking-widest flex items-center transition-colors">
                    <Lock size={12} className="inline mr-1" /> Admin Access
                </button>
            </footer>
        </div>
    );
}
